# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Collection of standalone shell scripts and a Python test tool for aarch64 SBC (Single Board Computer) administration. Two main areas:

1. **LUKS encryption scripts** — Full-disk encryption with clevis/tang (NBDE) for Raspberry Pi and Armbian boards (Rock 5B / RK3588). Three-script workflow: `luks_boot_split.sh` → `luks_prepare.sh` → `luks_encrypt.sh`.
2. **Rock 5B hardware tools** — Diagnostics (`rock5b-hw-check.sh`), USB boot setup (`rock5b-usb-boot-setup.sh`), NPU benchmarking (`rock5b-npu-test.py`), and Mesa/Teflon NPU driver build (`build-mesa-teflon.sh`).
3. **Image redaction tool** — `repo_scripts/blurimage.py`: OCR-based screenshot redaction using pytesseract/OpenCV. Multi-pass OCR (weighted, max-channel, blue-channel grayscale), OTSU thresholding, word+line level matching. German output.

Scripts are organized under `scripts/luks/` (LUKS encryption) and `scripts/rock5b/` (Rock 5B hardware tools). Repository automation lives in `repo_scripts/`.

Python tooling: `pyproject.toml` (hatchling build), `Makefile`, pre-commit hooks (black, mypy, gitleaks), Python 3.14, venv-based.

## Script Architecture

### LUKS encryption workflow (three scripts, strict order)

The scripts share configuration variables (tang servers, LUKS mapper name, LVM settings) that **must match** between `luks_prepare.sh` and `luks_encrypt.sh`. These are defined at the top of each script.

- **`luks_boot_split.sh`** — Only needed for in-place Armbian eMMC encryption. Creates a separate `/boot` partition either via initramfs hooks (on-board, requires reboot) or directly on an unmounted device (external mode). Two partition strategies: append (free space available) or shrink (insufficient free space).
- **`luks_prepare.sh`** — Runs on the target board. Detects board type (RPi vs Armbian), installs packages, configures initramfs (crypto modules, network driver for tang), creates hooks, stages boot configs to `/root/luks-staged/`.
- **`luks_encrypt.sh`** — Organized into 8 resumable phases (detect → backup → encrypt → restore → bootconfig → initramfs → clevis → verify). Supports `--start-phase` for resuming after failure. Handles local mode (Armbian NVMe/USB migration) and external mode (RPi). The `--spi-only` flag runs only SPI U-Boot flash.

### Additional LUKS utilities

- **`setup_clevis_tang.sh`** — (Re-)bind clevis/tang to an existing LUKS device. Deployed to `/root/` on the target board by `luks_encrypt.sh`. Supports SSS threshold with multiple tang servers.
- **`tang_check_connection.sh`** — Quick connectivity check for a LUKS device's clevis/tang binding. Takes the device path as argument.
- **`initramfs_local-bottom_cleanup-netplan`** — Initramfs hook that removes stale netplan YAML files generated by `configure_networking()` during boot. Prevents initramfs DHCP config from leaking into userspace (important for OVS bridge setups).

### Mesa/Teflon build scripts (Rock 5B)

- **`build-mesa-teflon.sh`** — Builds `libteflon.so` (Mesa Rocket/RK3588 NPU driver) from source on the Rock 5B. Flags: `--deps-only`, `--no-deps`, `--package`. Installs to `/usr/local/lib/teflon/` without touching system Mesa.
- **`release-mesa-teflon.sh`** — Creates a GitHub Release with the built `libteflon.so` tarball. Requires `gh` CLI. The `MESA_VERSION` variable **must match** between both scripts.

Workflow: build on Rock 5B → `make teflon-fetch` (rsync to workstation) → `make teflon-release` (create GitHub Release).

### Board detection pattern

Scripts detect the board type by checking for config files:
- RPi: `/boot/firmware/config.txt`
- Armbian: `/boot/armbianEnv.txt`

### Key conventions

- All shell scripts use `set -euo pipefail` and colored output helpers (`info`, `ok`, `warn`, `fail`).
- Scripts are designed to run as root (`sudo`).
- **German output**: `rock5b-npu-test.py`, `rock5b-hw-check.sh`, `rock5b-usb-boot-setup.sh`, `blurimage.py`, `update_badge.py`. `README_ROCKCHIP_5b.md` is also in German.
- **English output**: `luks_prepare.sh`, `luks_encrypt.sh`, and their README documentation.

## Rock 5B NPU context

Two NPU driver stacks exist — important when modifying scripts:

| Stack | Kernel | Driver | Device node | Model format |
|-------|--------|--------|-------------|-------------|
| Vendor (rknpu) | 6.1.x BSP | `rknpu.ko` | `/dev/dri/renderD129` | `.rknn` |
| Mainline (Rocket) | ≥6.18 | `rocket.ko` | `/dev/accel/accel0` | `.tflite` |

`rock5b-hw-check.sh` detects both stacks. `rock5b-npu-test.py` targets the Rocket/Teflon stack only.

## Development Commands

```bash
make install          # Create .venv (Python 3.14) and install deps
make tests            # Run pytest
make lint             # Format with black (line-length 120)
make isort            # Sort imports
make tcheck           # Static type checks with mypy
make gitleaks         # Run gitleaks pre-commit hook only
make commit-checks    # Run all pre-commit hooks (black, mypy, gitleaks)
make prepare          # tests + commit-checks
make teflon-fetch     # rsync libteflon.so build artifacts from Rock 5B (ROCK5B_HOST=root@rock5b)
make teflon-release   # teflon-fetch + create GitHub Release
```

Run a single test:
```bash
pytest tests/test_blurimage.py::TestBlurimageArgparse::test_image_before_blur -v
```

Pre-commit hooks: black (check + diff mode), mypy, gitleaks. Config in `.pre-commit-config.yaml`. Hooks use `fail_fast: true`.

## Python conventions

- **Strict mypy**: `disallow_untyped_defs`, `disallow_incomplete_defs`, `no_implicit_optional`. Tests are excluded from mypy.
- **TYPE_CHECKING guards**: Use `from __future__ import annotations` and `if TYPE_CHECKING:` for imports only needed by mypy (avoids runtime dependency on type stubs).
- **Auto-install pattern**: Some scripts (`blurimage.py`, `update_badge.py`) use an `install_and_import()` helper to pip-install missing packages at runtime.
- **asyncio_mode = "auto"**: Pytest auto-detects async tests, no need for `@pytest.mark.asyncio`.
- **`*.local.*` files are gitignored** — used for credentials and unredacted screenshots. Never commit these.
- **Exception syntax**: Always parenthesize multiple exception types: `except (FileNotFoundError, OSError):` — never use the comma-only form `except FileNotFoundError, OSError:` (Python 2 syntax, SyntaxError in Python 3).

## repo_scripts/

Repository automation for CI container builds and DockerHub integration:

- **`build-container-multiarch.sh`** — Builds multi-arch (amd64/arm64) container image using podman. Image: `xomoxcc/sbcstuff:python-3.14-slim-trixie`.
- **`initial_setup_github_dockerhub.sh`** — One-time setup: creates DockerHub repo, configures GitHub secrets, sets up pre-commit hooks.
- **`check_dockerhub_token.py`** — Validates DockerHub token scopes (pull/push/delete). JSON and ASCII table output.
- **`dh_login.py`** — DockerHub login with MFA/TOTP support. Env vars: `DOCKERHUB_ADMIN_USER`, `DOCKERHUB_ADMIN_PASSWORD`, `DOCKERHUB_TOTP_SECRET`.
- **`update_badge.py`** — Updates GitHub clone count badge via Gist + shields.io. Merges 14-day API window with historical data.
- **`include.sh`** / **`include.local.sh`** — Shared config loader. `include.sh` searches multiple paths for `include.local.sh`. `*.local.*` files are gitignored for credentials.

## CI/CD

Three GitHub workflows (`.github/workflows/`):
- **checkblack.yml** — Black lint check on push/PR.
- **mypynpytests.yml** — mypy + pytest on push/PR. Uses `make tcheck` and `pytest .`.
- **update-clone-badge.yml** — Scheduled (3x daily) clone count badge update via `update_badge.py`. Requires secrets: `GIST_TOKEN`, `GIST_ID`, `REPO_PRIV_TOKEN`.
