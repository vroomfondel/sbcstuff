# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Overview

Collection of standalone shell scripts and a Python test tool for aarch64 SBC (Single Board Computer) administration. Two main areas:

1. **LUKS encryption scripts** — Full-disk encryption with clevis/tang (NBDE) for Raspberry Pi and Armbian boards (Rock 5B / RK3588). Three-script workflow: `luks_boot_split.sh` → `luks_prepare.sh` → `luks_encrypt.sh`.
2. **Rock 5B hardware tools** — Diagnostics (`rock5b-hw-check.sh`), USB boot setup (`rock5b-usb-boot-setup.sh`), and NPU benchmarking (`rock5b-npu-test.py`).

Scripts are organized under `scripts/luks/` (LUKS encryption) and `scripts/rock5b/` (Rock 5B hardware tools). Repository automation lives in `repo_scripts/`.

Python tooling: `pyproject.toml` (hatchling build), `Makefile`, pre-commit hooks (black, mypy, gitleaks), Python 3.14, venv-based.

## Script Architecture

### LUKS encryption workflow (three scripts, strict order)

The scripts share configuration variables (tang servers, LUKS mapper name, LVM settings) that **must match** between `luks_prepare.sh` and `luks_encrypt.sh`. These are defined at the top of each script.

- **`luks_boot_split.sh`** — Only needed for in-place Armbian eMMC encryption. Creates a separate `/boot` partition either via initramfs hooks (on-board, requires reboot) or directly on an unmounted device (external mode). Two partition strategies: append (free space available) or shrink (insufficient free space).
- **`luks_prepare.sh`** — Runs on the target board. Detects board type (RPi vs Armbian), installs packages, configures initramfs (crypto modules, network driver for tang), creates hooks, stages boot configs to `/root/luks-staged/`.
- **`luks_encrypt.sh`** — Organized into 8 resumable phases (detect → backup → encrypt → restore → bootconfig → initramfs → clevis → verify). Supports `--start-phase` for resuming after failure. Handles local mode (Armbian NVMe/USB migration) and external mode (RPi). The `--spi-only` flag runs only SPI U-Boot flash.

### Additional LUKS utilities

- **`setup_clevis_tang.sh`** — (Re-)bind clevis/tang to an existing LUKS device. Deployed to `/root/` on the target board by `luks_encrypt.sh`. Supports SSS threshold with multiple tang servers.
- **`tang_check_connection.sh`** — Quick connectivity check for a LUKS device's clevis/tang binding. Takes the device path as argument.
- **`initramfs_local-bottom_cleanup-netplan`** — Initramfs hook that removes stale netplan YAML files generated by `configure_networking()` during boot. Prevents initramfs DHCP config from leaking into userspace (important for OVS bridge setups).

### Mesa/Teflon build scripts (Rock 5B)

- **`build-mesa-teflon.sh`** — Builds `libteflon.so` (Mesa Rocket/RK3588 NPU driver) from source on the Rock 5B. Flags: `--deps-only`, `--no-deps`, `--package`. Installs to `/usr/local/lib/teflon/` without touching system Mesa.
- **`release-mesa-teflon.sh`** — Creates a GitHub Release with the built `libteflon.so` tarball. Requires `gh` CLI. The `MESA_VERSION` variable **must match** between both scripts.

Workflow: build on Rock 5B → `make teflon-fetch` (rsync to workstation) → `make teflon-release` (create GitHub Release).

### Board detection pattern

Scripts detect the board type by checking for config files:
- RPi: `/boot/firmware/config.txt`
- Armbian: `/boot/armbianEnv.txt`

### Key conventions

- All shell scripts use `set -euo pipefail` and colored output helpers (`info`, `ok`, `warn`, `fail`).
- Scripts are designed to run as root (`sudo`).
- The Python script (`rock5b-npu-test.py`) uses German-language output strings (consistent with `rock5b-hw-check.sh` and `rock5b-usb-boot-setup.sh`). `README_ROCKCHIP_5b.md` is also in German.
- `luks_prepare.sh` and `luks_encrypt.sh` use English output strings and English README documentation.

## Rock 5B NPU context

Two NPU driver stacks exist — important when modifying scripts:

| Stack | Kernel | Driver | Device node | Model format |
|-------|--------|--------|-------------|-------------|
| Vendor (rknpu) | 6.1.x BSP | `rknpu.ko` | `/dev/dri/renderD129` | `.rknn` |
| Mainline (Rocket) | ≥6.18 | `rocket.ko` | `/dev/accel/accel0` | `.tflite` |

`rock5b-hw-check.sh` detects both stacks. `rock5b-npu-test.py` targets the Rocket/Teflon stack only.

## Development Commands

```bash
make install          # Create .venv (Python 3.14) and install deps
make tests            # Run pytest
make lint             # Format with black (line-length 120)
make isort            # Sort imports
make tcheck           # Static type checks with mypy
make commit-checks    # Run all pre-commit hooks (black, mypy, gitleaks)
make prepare          # tests + commit-checks
make teflon-fetch     # rsync libteflon.so build artifacts from Rock 5B
make teflon-release   # teflon-fetch + create GitHub Release
```

Pre-commit hooks: black (check + diff mode), mypy, gitleaks. Config in `.pre-commit-config.yaml`.

## repo_scripts/

Repository automation for CI container builds and DockerHub integration:

- **`build-container-multiarch.sh`** — Builds multi-arch (amd64/arm64) container image using podman. Image: `xomoxcc/sbcstuff:python-3.14-slim-trixie`.
- **`initial_setup_github_dockerhub.sh`** — One-time setup: creates DockerHub repo, configures GitHub secrets, sets up pre-commit hooks.
- **`check_dockerhub_token.py`** / **`dh_login.py`** / **`update_badge.py`** — DockerHub token validation, login, and README badge updates.
- **`include.sh`** / **`include.local.sh`** — Shared config. `*.local.*` files are gitignored for credentials.
